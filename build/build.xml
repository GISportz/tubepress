<?xml version="1.0"?>
<!--
/**
 * Copyright 2006 - 2015 TubePress LLC (http://tubepress.com)
 *
 * This file is part of TubePress (http://tubepress.com)
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */
-->
<project name="free" default="deploy" basedir=".">

    <!-- ######################################################################################## -->
    <!-- ## TARGETS                                                                               -->
    <!-- ######################################################################################## -->

    <target name="clean" description="Cleans build environment">
        <log msg="Deleting dist and stage" />
        <delete dir="dist" />
        <delete dir="stage" />
    </target>

    <target name="stage">
        <common-build-jobs />
        <stage-web-assets />
    </target>

    <target name="deploy" depends="stage">
        <log msg="Deploying to ${tubepress.deploy.directory}" />
        <exec executable="rsync">
            <arg value="-ah" />
            <arg value="--delete" />
            <arg value="${dir.stage}/" />
            <arg value="${tubepress.deploy.directory}/" />
        </exec>
    </target>

    <target name="package" description="Builds a distributable version of TubePress">
        <common-build-jobs />
        <compress-js />
        <compress-css />
        <stage-web-assets />
        <copy-locale-fallbacks />
        <package-starter-theme />
        <final-package />
    </target>

    <!-- ######################################################################################## -->
    <!-- ## MACROS                                                                                -->
    <!-- ######################################################################################## -->

    <macrodef name="common-build-jobs" description="internal use only">
        <sequential>
            <prepare-build-environment />
            <copy-tubepress-to-staging-directory />
            <copy-user-content-skeleton-into-wp />
            <move-wordpress-skeleton />
            <suppress-directory-listings />
            <modify-wp-manifest />
            <build-boot-classes-file />
            <php-52-compatability-mods />
            <strip-phpunit-from-composer />
            <replace-version-placeholders-with-real-version />
        </sequential>
    </macrodef>

    <macrodef name="prepare-build-environment" description="Cleans and preps the build directory for a new build">
        <sequential>
            <log msg="Creating empty directories at dist and stage" />
            <delete dir="dist" />
            <mkdir dir="dist" />
            <mkdir dir="stage" />
            <initialize-properties />
        </sequential>
    </macrodef>

    <macrodef name="copy-tubepress-to-staging-directory" description="Copies over TubePress into the staging directory for processing">
        <sequential>
            <log msg="Copying files into ${dir.stage}" />
            <exec executable="rsync">
                <arg value="-ah" />
                <arg value="--delete" />
                <arg value="--delete-excluded" />
                <arg value="--exclude-from=${basedir}/config/lists/distribution-exclusions.txt" />
                <arg value="../" />
                <arg value="${dir.stage}/" />
            </exec>
        </sequential>
    </macrodef>

    <macrodef name="copy-user-content-skeleton-into-wp" description="Stages the user content skeleton into WP for the activation hook">
        <sequential>
            <log msg="Copying user content skeleton into WP add-on for the activation hook" />
            <copy todir="${dir.stage}/src/add-ons/wordpress/resources/user-content-skeleton">
                <fileset dir="resources/user-content-skeleton" />
            </copy>
        </sequential>
    </macrodef>

    <macrodef name="move-wordpress-skeleton" description="Copies WordPress resources into TubePress's root">
        <sequential>
            <log msg="Moving WP-specific files to root directory" />
            <move todir="${dir.stage}">
                <fileset dir="${dir.stage}/src/add-ons/wordpress/resources/root-skeleton">
                    <include name="**" />
                </fileset>
            </move>
        </sequential>
    </macrodef>

    <macrodef name="suppress-directory-listings" description="Adds empty index.php files to various areas">
        <sequential>
            <log msg="Suppressing directory listing" />
            <copy file="resources/directory-listing-suppressor.php" tofile="${dir.stage}/index.php" />
        </sequential>
    </macrodef>

    <macrodef name="php-52-compatability-mods" description="Minor code tweaks for PHP 5.2 compatibility">
        <sequential>
            <log msg="PHP 5.2 compatability mods" />
            <replace dir="${dir.stage}" token="__DIR__" value="dirname(__FILE__)" includes="**/*.php" />
        </sequential>
    </macrodef>

    <macrodef name="stage-web-assets" description="Moves add-on web assets into the root web directory">
        <sequential>

            <log msg="Staging web assets from add-ons" />
            <move file="${dir.stage}/src/add-ons/gallery/web"   tofile="${dir.stage}/web" />
            <move file="${dir.stage}/src/add-ons/html/web"      tofile="${dir.stage}/web" />
            <move file="${dir.stage}/src/add-ons/http/web"      tofile="${dir.stage}/web" />
            <move file="${dir.stage}/src/add-ons/player/web"    tofile="${dir.stage}/web" />
            <move file="${dir.stage}/src/add-ons/wordpress/web" tofile="${dir.stage}/web" />

            <log msg="Suppressing directory listing of /web directory" />
            <copy file="${dir.stage}/index.php" tofile="${dir.stage}/web/index.php" />

            <log msg="Staging themes" />
            <move todir="${dir.stage}/web/themes">
                <fileset dir="${dir.stage}/src/themes/public/">
                    <include name="**" />
                </fileset>
            </move>
            <move todir="${dir.stage}/web/admin-themes">
                <fileset dir="${dir.stage}/src/themes/admin/">
                    <include name="**" />
                </fileset>
            </move>
            <delete dir="${dir.stage}/src/themes" />

        </sequential>
    </macrodef>

    <macrodef name="replace-version-placeholders-with-real-version" description="Replaces 99.99.99 with the actual TubePress version">
        <sequential>
            <__replace-version-in-files includes="**/manifest.json" />
            <__replace-version-in-files includes="**/theme.json" />
            <__replace-version-in-files includes="src/php/scripts/boot.php" />
            <__replace-version-in-files includes="src/php/scripts/classloading/classes.php" />
        </sequential>
    </macrodef>

    <macrodef name="__replace-version-in-files" description="internal use only">
        <attribute name="includes" />
        <sequential>
            <log msg="Replacing version placeholder(s) in @{includes} with real version" />
            <replace dir="${dir.stage}"
                     token="99.99.99"
                     value="${tubepress.version.major}.${tubepress.version.minor}.${tubepress.version.micro}"
                     failOnNoReplacements="true"
                     includes="@{includes}" />
        </sequential>
    </macrodef>

    <macrodef name="modify-wp-manifest" description="Updates tubepress.php with the correct title and description, for WP users">
        <sequential>
            <log msg="Updating tubepress.php with the correct title and description, for WP users" />
            <replace file="${dir.stage}/tubepress.php" token="@description@" value="${tubepress.wp.desc}"  failOnNoReplacements="true"/>
            <replace file="${dir.stage}/tubepress.php" token="@TubePress@"   value="${tubepress.wp.title}" failOnNoReplacements="true" />
            <__replace-version-in-files includes="tubepress.php" />
        </sequential>
    </macrodef>

    <macrodef name="strip-phpunit-from-composer" description="Removes PHPUnit from composer's classloader">
        <sequential>
            <__strip-phpunit-from-composer file="vendor/composer/autoload_classmap.php" />
            <__strip-phpunit-from-composer file="vendor/composer/include_paths.php" />
        </sequential>
    </macrodef>

    <macrodef name="__strip-phpunit-from-composer" description="Removes PHPUnit from composer's classloader">
        <attribute name="file" />
        <sequential>
            <log msg="Removing PHPUnit from @{file}" />
            <exec dir="${dir.stage}" failonerror="true" searchpath="true" executable="sed" os="Linux">
                <arg value="-i" />
                <arg value="/\/phpunit\//d" />
                <arg value="@{file}" />
            </exec>
            <exec dir="${dir.stage}" failonerror="true" searchpath="true" executable="sed" os="Mac OS X">
                <arg value="-i" />
                <arg value="''" />
                <arg value="/\/phpunit\//d" />
                <arg value="@{file}" />
            </exec>
        </sequential>
    </macrodef>

    <macrodef name="build-boot-classes-file">
        <sequential>
            <log msg="Building classes.php" />
            <exec dir="bin" failonerror="true" searchpath="true" executable="php">
                <arg value="./ClassCollectionBuilder.php" />
            </exec>
            <move file="../src/php/scripts/classloading/classes.php"
                  tofile="${dir.stage}/src/php/scripts/classloading/classes.php" />
        </sequential>
    </macrodef>

    <macrodef name="copy-locale-fallbacks">
        <sequential>
            <log msg="Copying locale fallbacks" />
            <copy file="${dir.stage}/src/translations/tubepress-es_ES.mo"
                  tofile="${dir.stage}/src/translations/tubepress-es_MX.mo" />
        </sequential>
    </macrodef>

    <macrodef name="package-starter-theme">
        <sequential>
            <log msg="Zipping up starter theme" />
            <mkdir dir="${dir.stage}/web/themes/temp" />
            <copy todir="${dir.stage}/web/themes/temp/starter">
                <fileset dir="${dir.stage}/src/add-ons/wordpress/resources/user-content-skeleton/themes/starter" />
            </copy>
            <zip destfile="${dir.stage}/web/themes/starter-theme.zip" basedir="${dir.stage}/web/themes/temp" />
            <delete dir="${dir.stage}/web/themes/temp" />
        </sequential>
    </macrodef>

    <macrodef name="final-package">
        <sequential>
            <log msg="Performing final zip" />
            <zip destfile="dist/${tubepress.stage-directory-basename}_${tubepress.version.major}_${tubepress.version.minor}_${tubepress.version.micro}.zip" basedir="stage" />
        </sequential>
    </macrodef>

    <macrodef name="compress-js" description="Compresses JS files">
        <sequential>
            <save-dev-copies-of-files path-to-file-list="${jscompresslist}" suffix=".js" />
            <yui path-to-file-list="${jscompresslist}" />
        </sequential>
    </macrodef>

    <macrodef name="compress-css" description="Compresses CSS files">
        <sequential>
            <save-dev-copies-of-files path-to-file-list="${csscompresslist}" suffix=".css" />
            <yui path-to-file-list="${csscompresslist}" />
        </sequential>
    </macrodef>

    <macrodef name="save-dev-copies-of-files">
        <attribute name="path-to-file-list" />
        <attribute name="suffix" />
        <sequential>
            <log msg="Saving dev copies of files in @{path-to-file-list}" />
            <copy todir="${dir.stage}">
                <fileset dir="${dir.stage}/" includesfile="@{path-to-file-list}"/>
                <mapper type="glob" from="*@{suffix}" to="*-dev@{suffix}" />
            </copy>
        </sequential>
    </macrodef>

    <macrodef name="yui" description="Compresses CSS and JS files">
        <attribute name="path-to-file-list" />
        <sequential>
            <log msg="Invoking YUI Compressor for files in @{path-to-file-list}" />
            <apply executable="java" parallel="false" dir="${dir.stage}" relative="true">
                <fileset dir="${dir.stage}/" includesfile="@{path-to-file-list}"/>
                <arg line="-jar"/>
                <arg path="${dir.build.free}/bin/yuicompressor-2.4.8.jar"/>
                <srcfile />
                <arg line="-o" />
                <mapper type="identity" />
                <targetfile />
            </apply>
        </sequential>
    </macrodef>

    <macrodef name="initialize-properties">
        <sequential>

            <dirname file="${ant.file.free}" property="dir.build.free" />
            <dirname file="${ant.file.pro}"  property="dir.build.pro" />

            <property file="${dir.build.free}/config/version.properties" />
            <property file="${dir.build.free}/config/local.properties" />
            <property file="${dir.build.pro}/config/pro.properties" />
            <property file="${dir.build.free}/config/default.properties" />

            <property name="dir.stage"       value="stage/${tubepress.stage-directory-basename}" />
            <property name="dir.stage.free"  value="${dir.build.free}/stage/${tubepress.stage-directory-basename}" />
            <property name="dir.stage.pro"   value="${dir.build.pro}/stage/${tubepress.stage-directory-basename}" />
            <property name="jscompresslist"  value="config/lists/js-to-compress.txt" />
            <property name="csscompresslist" value="config/lists/css-to-compress.txt" />
        </sequential>
    </macrodef>

    <macrodef name="log">
        <attribute name="msg" />
        <sequential>
            <echo message="@{msg} " />
        </sequential>
    </macrodef>

</project>
